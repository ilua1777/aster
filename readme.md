# Краткое руководство

## Шаг №1

Asterisk умеет отдавать события в сокет. На PHP можно отслеживать эти события, для этого требуется настроить конфиг /etc/asterisk/manager_custom.conf.

Настраивается следующим образом:

[имя пользователя]
secret = пароль
deny=0.0.0.0/0.0.0.0 - запрет на подключения со всех портов
permit=127.0.0.1/255.255.255.0 - разрешение на прослушивание с локалки
read = system,call,log,verbose,command,agent,user,config,command,dtmf,reporting,cdr,dialplan,originate,message - права пользователя на чтение
write = system,call,log,verbose,command,agent,user,config,command,dtmf,reporting,cdr,dialplan,originate,message - права пользователя на запись
writetimeout = 5000 - максимальное время ожидания записи

Далее следует перезагрузка службы

## Шаг №2

Текущий скрипт устанавливается на сервер в домашнюю директорию. Далее устанавливается [composer](https://baks.dev/article/centos/how-to-install-and-use-php-composer-on-centos-7).

Вводяться команды установки ```composer update```. Возможно при первом запуске потребуется ввести ```composer dump-autoload```. Все команды вводяться из под корня проекта.

## Шаг №3

Для того чтобы сокет прослушивался и скрипт не умирал следует установить supervisor.
[Ссылка на него](https://cloudwafer.com/blog/how-to-install-and-configure-supervisor-on-centos-7/). Конфиг supervisor лежит в корне проекта (callme.ini). На этом настройка закончена.

### Использование

Для использования потребуется исправить конфигурационный файл asterisk.php, а именно подставить данные из шага 1.

В файле callIn.php уже есть готовый код для отслеживания события звонка, состояния абонента в этот момент и состояния вызова (занят, звонит, сбросил). В функции можно выполнять любой php код. На данный момент реализована отправка HTTP запроса через curl на сторонний сервер.